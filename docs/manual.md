# Руководство пользователя: ytd

Полное руководство по установке, настройке и использованию CLI‑утилиты ytd для загрузки видео и аудио с площадок, поддерживаемых yt-dlp (YouTube, VK, Twitch, SoundCloud и др.).

Дата: 27.10.2025

---

## Самое нужное (TL;DR)

- **Один URL — одно действие.** Команда `download` сама определяет, плейлист это или одиночное видео:

  ```powershell
  ytd download https://vk.com/video-12345_67890
  # одинаково работает для YouTube, VK и других площадок из списка yt-dlp
  ```

- **Список ссылок из файла** (одна ссылка в строке, строки с `#` пропускаются):

  ```powershell
  ytd download --urls-file urls.local.txt
  ```

- **Интерактивный выбор качества** для одиночного URL (если не включён по умолчанию в конфиге):

  ```powershell
  ytd download URL --interactive
  ```

  Чтобы диалог включался автоматически, добавьте в конфиг:

  ```yaml
  interactive_by_default: true
  ```

- **Только аудио в формате m4a** с пользовательским шаблоном имени:

  ```powershell
  ytd download URL --audio-only --audio-format m4a -o ./downloads --name "%(title)s [%(id)s]"
  ```

- **Ограничить элементы плейлиста** или задать нумерацию:

  ```powershell
  ytd download PLAYLIST_URL --playlist-items 1-3
  ```

- **Пауза между элементами плейлиста** (работает и через конфиг `pause_between_videos: true`):

  ```powershell
  ytd download PLAYLIST_URL --pause-between
  ```

- **Просмотр информации без скачивания:**

  ```powershell
  ytd info URL
  ```

---

## 1. Требования и установка

- ОС: Windows (PowerShell), а также совместимо с macOS/Linux
- Python: 3.11+
- ffmpeg: рекомендуется установленный в PATH (yt-dlp сам вызовет при необходимости)

Примеры установки ffmpeg на Windows:

```powershell
# через winget
winget install --id Gyan.FFmpeg -e
# или через Chocolatey
# choco install ffmpeg
```

Установка зависимостей и консольного скрипта (варианты):

- Если проект в исходниках (локально):

```powershell
python -m venv .venv
.\.venv\Scripts\Activate.ps1
python -m pip install -U pip
python -m pip install -e .
```

После установки доступна команда `ytd`:

```powershell
ytd --help
```

---

## 2. Быстрый старт

- Загрузить одно видео или целый плейлист лучшего качества: см. TL;DR
- Выбрать качество интерактивно: `--interactive` предложит список вариантов (1080p/720p/.../аудио) или включите `interactive_by_default` в конфиге
- Плейлисты распознаются автоматически; при необходимости ограничьте элементы `--playlist-items 1-3` или `--playlist-items 1,3,5`

Совет: для проверки без фактической загрузки используйте `--dry-run`.

---

## 3. Команда download

Синопсис:

```powershell
ytd download [URL] [ОПЦИИ]
```

Основные опции:

- `-o, --output DIR` — папка назначения (по умолчанию `./downloads`)
- `--urls-file PATH` — файл со ссылками (по одной в строке; строки, начинающиеся с `#`, игнорируются)
- `--audio-only` — скачать только аудио (MP4→M4A или WebM→OPUS/MP3)
- `--audio-format [m4a|mp3|opus]` — формат аудио при `--audio-only`
- `--video-format [mp4|webm]` — предпочтительный видео-контейнер
- `--quality [best|1080p|720p|audio]` — пресеты качества
- `--name TEMPLATE` — шаблон имени файла (в стиле yt-dlp, напр. `%(title)s [%(id)s].%(ext)s`)
  - По умолчанию: `%(title)s [%(id)s].%(ext)s`
  - `%(id)s` — уникальный идентификатор видео/трека на выбранной площадке (для YouTube — 11 символов из URL)
  - Квадратные скобки `[VIDEO_ID]` в имени файла нужны для:
    - Уникальности (даже при одинаковых названиях видео)
    - Точного обнаружения существующих файлов и предотвращения дубликатов
    - Возможности восстановить ссылку на оригинальное видео
  - **Не рекомендуется** удалять `[%(id)s]` из шаблона — программа потеряет возможность надёжно проверять наличие файлов
- `--subtitles LANGS` — языки субтитров (например, `--subtitles ru en`)
- `--proxy URL` — прокси (HTTP/SOCKS)
- `--retry N` — число повторов при ошибках сети (по умолчанию 3)
- `--retry-delay SEC` — задержка между повторами (сек)
- `--dry-run` — показать, что будет сделано, без скачивания
- `--playlist` — принудительно обработать URL как плейлист (обычно не требуется, autodetect работает автоматически)
- `--playlist-items TEXT` — ограничения плейлиста: `'1-3'` или `'1,3,5'`
- `-i, --interactive` — диалоговый выбор качества и настроек (для одиночных видео и плейлистов)
- `-v, --verbose` — подробные логи (DEBUG) в консоль

Поведение:

- По умолчанию выбирается лучшее доступное качество, соответствующее `--video-format`.
- При `--audio-only` используется `FFmpegExtractAudio` для конвертации/выделения аудио.
- При `--interactive` утилита работает в диалоговом режиме:
  - **Для одиночных видео** (см. раздел 7.1):
    1. Выбор качества из доступных форматов
    2. Настройка имени файла (суффикс качества, префикс)
    3. Проверка существующих файлов и выбор перезаписи
  - **Для плейлистов** (см. раздел 7.2):
    1. Выбор режима: единые настройки для всех или настройка каждого видео
    2. Выбор качества и стратегии подбора при отсутствии целевого
    3. Настройка нумерации и суффиксов для всех видео
    4. Подтверждение с предпросмотром примера
- Возобновление прерванных загрузок поддерживается yt-dlp автоматически (файлы `.part`).

Примеры:

```powershell
# Лучшее качество (по умолчанию)
ytd download https://www.youtube.com/watch?v=VIDEO_ID

# Только аудио в MP3
ytd download URL --audio-only --audio-format mp3 -o ./music

# Плейлист, первые 10 видео
ytd download PLAYLIST_URL --playlist-items 1-10

# Интерактивный выбор качества
ytd download URL --interactive
```

```

---

## 4. Команда info

Синопсис:

```powershell
ytd info URL [--verbose] [--json]
```

Описание:

- Показывает информацию о видео или плейлисте: ID, название, канал, длительность, примеры форматов.
- С `--json` выводит сырой JSON (для дальнейшей обработки).
- С `--verbose` показывает расширенные логи yt-dlp.

Примеры:

```powershell
ytd info https://www.youtube.com/watch?v=VIDEO_ID
ytd info https://www.youtube.com/playlist?list=LIST_ID --verbose
ytd info URL --json > info.json
```

---

## 5. Конфигурация и переменные окружения

Файл конфигурации: `ytd.config.yaml` (в текущем каталоге проекта) позволяет задать значения по умолчанию.

Пример:

```yaml
output: ./downloads
quality: best
video_format: mp4
audio_only: false
audio_format: m4a
name_template: "%(title)s [%(id)s].%(ext)s"
subtitles: []
proxy: null
retry: 3
retry_delay: 5
save_metadata: ./data/meta.jsonl
```

Переменные окружения (приоритет выше конфига, ниже флагов CLI):

- `YTD_OUTPUT`
- `YTD_QUALITY`
- `YTD_VIDEO_FORMAT`
- `YTD_AUDIO_ONLY`
- `YTD_AUDIO_FORMAT`
- `YTD_NAME_TEMPLATE`
- `YTD_SUBTITLES` (через пробел)
- `YTD_PROXY`
- `YTD_RETRY`
- `YTD_RETRY_DELAY`
- `YTD_SAVE_METADATA`

Приоритет значений: CLI > ENV > файл конфигурации > значения по умолчанию.

### О формате имён файлов и video ID

По умолчанию файлы сохраняются с шаблоном `%(title)s [%(id)s].%(ext)s`, например:

```
"Линейная алгебра", Кожевников П. А. 03.02.2021г [LYCBwmd-7-E].mp4
                                                    └──────────┘
                                                      video ID
```

**Что такое video ID?**

- Уникальный идентификатор объекта (видео, трансляции, аудио) на конкретной площадке
- Для YouTube это 11-символьная строка из URL: `https://www.youtube.com/watch?v=LYCBwmd-7-E`
- Для других сайтов формат может отличаться (например, числовой ID VK)
- Не меняется со временем (в отличие от названия видео)

**Зачем ID в квадратных скобках в имени файла?**

1. **Уникальность**: Даже если на канале несколько видео с одинаковым названием, ID всегда уникален
2. **Обнаружение дубликатов**: Программа проверяет наличие файлов по точному совпадению `[VIDEO_ID]` в имени
3. **Интерактивный режим**: При выборе `--interactive` программа показывает только файлы с таким же ID
4. **Перезапись**: Даже если вы добавили префикс или суффикс качества, программа найдёт файл по ID
5. **Отслеживаемость**: Всегда можно восстановить ссылку на оригинал

**Можно ли убрать ID?**

Технически да, через `--name "%(title)s.%(ext)s"`, но **не рекомендуется**:

- ❌ Программа не сможет точно находить существующие файлы
- ❌ Интерактивный режим не сработает корректно
- ❌ Возможна повторная загрузка одного и того же видео
- ❌ Потеряется связь с оригиналом

**Вывод:** Квадратные скобки с ID — стандарт yt-dlp для надёжной работы, лучше их сохранить.

---

## 6. Метаданные и логи

- Метаданные: по умолчанию сохраняются в `data/meta.jsonl` (одна запись JSON на строку). Путь можно задать в конфиге (`save_metadata`) или через `YTD_SAVE_METADATA`.
- Логи: пишутся в файл `logs/ytd.log` (ротация), в консоль выводится кратко (INFO). При `--verbose` — подробные логи.

---

## 7. Интерактивный режим (--interactive)

Флаг `--interactive` или `-i` активирует пошаговый диалоговый режим для точной настройки загрузки одиночного видео или плейлиста.

### 7.1. Интерактивный режим для одиночного видео

Команда:

```powershell
ytd download URL --interactive
# если в конфиге включено interactive_by_default: true, достаточно ytd download URL
```

### Шаг 1: Выбор качества

Программа получает доступные форматы и показывает меню:

```
════════════════════════════════════════════════════════════
ШАГ 1: Выберите качество
════════════════════════════════════════════════════════════
  1) Лучшее доступное качество
  2) Видео MP4 1080p
  3) Видео MP4 720p
  4) Видео MP4 360p
  5) Видео MP4 144p
  6) Только аудио (m4a)
Номер варианта [1]:
```

Варианты качества формируются автоматически на основе доступных форматов для конкретного видео.

### Шаг 2: Настройка имени файла

После выбора качества программа показывает информацию о видео и предлагает настроить имя:

```
════════════════════════════════════════════════════════════
ШАГ 2: Настройка имени файла
════════════════════════════════════════════════════════════
Название: "Линейная алгебра", Кожевников П. А. 03.02.2021г [LYCBwmd-7-E]
Расширение: .mp4
Предложенный суффикс качества: _720p

Добавить суффикс качества к имени файла?
  1) Да, добавить '_720p'
  2) Да, но указать свой суффикс
  3) Нет, без суффикса
Выберите вариант [1]:
```

**Настройка суффикса качества:**
- Вариант 1: добавляет автоматический суффикс (`_720p`, `_1080p`, `_audio` и т.д.)
- Вариант 2: позволяет указать произвольный суффикс (например, `_hd`, `_mobile`)
- Вариант 3: файл сохраняется без суффикса качества

**Дополнительные опции:**

```
Итоговое имя: "Линейная алгебра", Кожевников П. А. 03.02.2021г [LYCBwmd-7-E]_720p.mp4

Дополнительные опции:
  1) Использовать как есть
  2) Добавить префикс (например, '01_')
  3) Изменить имя полностью
Выберите действие [1]:
```

- Вариант 1: использовать сформированное имя
- Вариант 2: добавить префикс для нумерации (`01_`, `02_`, `Лекция_1_` и т.д.)
- Вариант 3: полностью переопределить имя файла

### Шаг 3: Проверка существующих файлов

Программа сканирует папку загрузки и ищет файлы с таким же video ID:

```
════════════════════════════════════════════════════════════
⚠ ВНИМАНИЕ: Найдены существующие файлы этого видео:
════════════════════════════════════════════════════════════
  1) "Линейная алгебра", Кожевников П. А. 03.02.2021г. [LYCBwmd-7-E].mp4 (1022.1 МБ)

Перезаписать существующие файлы? (y/n) [n]:
```

- `y` / `yes` / `д` / `да` — перезаписать существующие файлы (с флагом `overwrites: True` для yt-dlp)
- `n` / `no` / любой другой ввод — пропустить загрузку, если файл уже существует (поведение yt-dlp по умолчанию)

**Примечание:** Поиск существующих файлов выполняется по точному совпадению video ID в квадратных скобках `[VIDEO_ID]` в имени файла. Это позволяет избежать повторной загрузки одного и того же видео в разных форматах/качествах.

### 7.2. Интерактивный режим для плейлистов

Команда:

```powershell
ytd download PLAYLIST_URL --interactive
```

При запуске из файла ссылок достаточно `ytd download --urls-file urls.txt`; приложение само определит, что это плейлист, и предложит диалог, если включён `interactive_by_default` или передан `--interactive`.

При запуске программа:

1. **Получает информацию о плейлисте** (с индикатором прогресса)
2. **Показывает список видео** с длительностью
3. **Предлагает выбрать режим**:
   - **Режим 1: Единые настройки для всех видео** (быстро, рекомендуется)
   - **Режим 2: Настроить каждое видео отдельно** (гибко, долго)

#### Режим 1: Единые настройки для всех видео

Этот режим позволяет один раз выбрать параметры, которые будут применены ко всем видео плейлиста:

**Шаг 1: Выбор качества**
```
Выберите качество:
  1) Лучшее доступное качество
  2) Видео MP4 720p
  3) Видео MP4 480p
  ...
```

**Шаг 2: Суффикс качества**
```
Добавить суффикс качества к имени файла?
  1) Да, добавить '_720p'
  2) Да, но указать свой суффикс
  3) Нет, без суффикса
```

**Шаг 3: Нумерация файлов**
```
Добавить номера к именам файлов?
  1) Да, с автоинкрементом (01_, 02_, 03_...)
  2) Да, с пользовательским шаблоном префикса
  3) Нет
```

**Шаг 4: Стратегия подбора качества**

Если выбранное качество недоступно для некоторых видео:

```
  1) эконом — сначала ≤ выбранного, если нет — ≥ выбранного (рекомендуется)
  2) богато — сначала ≥ выбранного, если нет — ≤ выбранного
```

**Стратегии подбора:**

- **Эконом** (рекомендуется): Сначала ищет максимальное качество НЕ ВЫШЕ выбранного (экономит трафик), если такого нет — берёт минимальное НЕ НИЖЕ выбранного
- **Богато**: Сначала ищет максимальное качество НЕ НИЖЕ выбранного (максимальное качество), если такого нет — берёт максимальное НЕ ВЫШЕ выбранного

**Шаг 5: Перезапись файлов**
```
Перезаписывать существующие файлы в плейлисте? (y/n) [n]:
```

**Шаг 6: Подтверждение**

Программа показывает итоговую конфигурацию с примером имени файла:

```
════════════════════════════════════════════════════════════
Итоговые настройки для плейлиста:
════════════════════════════════════════════════════════════
Качество: Видео MP4 720p
Суффикс качества: _720p
Префикс/нумерация: {N:02d}_
Если качество недоступно: эконом — сначала ≤ выбранного, если нет — ≥ выбранного

Пример имени файла:
  01_Как собрать Кубик Рубика 3х3. 1 часть - КРЕСТ [6aJ5Bpqzb1s]_720p.mp4

Начать загрузку? (y/n) [y]:
```

**Процесс загрузки:**

Программа показывает прогресс для каждого видео:

```
════════════════════════════════════════════════════════════
▶ Начинаем загрузку плейлиста (7 видео)...
════════════════════════════════════════════════════════════

[1/7] Обработка...
  ⏳ Загрузка: Как собрать Кубик Рубика 3х3. 1 часть - КРЕСТ...
  ✓ [OK] Как собрать Кубик Рубика 3х3. 1 часть - КРЕСТ.

[2/7] Обработка...
  ⏳ Загрузка: Как собрать Кубик Рубика 3х3. 2 часть - УГЛЫ...
  ✓ [OK] Как собрать Кубик Рубика 3х3. 2 часть - УГЛЫ.
...
```

#### Режим 2: Настроить каждое видео отдельно

**Статус**: В разработке (TODO)

Будет позволять настраивать параметры для каждого видео индивидуально с опцией "Применить эти настройки ко всем оставшимся".

### Пример полного интерактивного сеанса для плейлиста

```powershell
ytd download --urls-file .\urls.local.txt --interactive

# Режим: 1) Единые настройки
# Качество: 2) 720p
# Суффикс: 1) Да, '_720p'
# Нумерация: 1) Да, автоинкремент
# Стратегия: 1) эконом
# Перезапись: n
# Подтверждение: y
# 
# Результат: 
#   01_Видео 1 [ID1]_720p.mp4
#   02_Видео 2 [ID2]_720p.mp4
#   ...
```

---

## 8. Коды возврата

- `0` — успех (файлы скачаны или информация получена)
- `1` — ошибка (исключение, KeyboardInterrupt)
- `2` — частичный успех или нет файлов (например, пустой плейлист)

---

## 9. Частые сценарии

- Загрузка аудиоподкаста в MP3:

```powershell
ytd download URL --audio-only --audio-format mp3 -o ./podcasts
```

- Интерактивная загрузка одиночного видео с выбором качества:

```powershell
ytd download URL --interactive
# В диалоге выберите качество, добавьте префикс '01_' и суффикс качества
```

- Интерактивная загрузка плейлиста с нумерацией:

```powershell
ytd download PLAYLIST_URL --interactive
# Выберите режим 1, качество 720p, включите автонумерацию
# Результат: 01_Видео [ID]_720p.mp4, 02_Видео [ID]_720p.mp4, ...
```

- Скачивание плейлиста курса с ограничением по элементам:

```powershell
ytd download PLAYLIST_URL --playlist-items 1-20
```

- Работа через прокси:

```powershell
ytd download URL --proxy http://user:pass@host:port
```

- Пакетная загрузка из файла:

```powershell
ytd download --urls-file urls.txt -o ./downloads
```

- Интерактивная загрузка одиночного видео с проверкой дубликатов:

```powershell
ytd download URL --interactive
# Программа покажет найденные файлы с тем же video ID и предложит перезаписать
```

- Предварительный просмотр настроек плейлиста без загрузки:

```powershell
ytd download PLAYLIST_URL --interactive --dry-run
# Пройдёте все диалоги и увидите примеры имён файлов без скачивания
```

---

## 10. Устранение неполадок

- "ffmpeg не найден": установите ffmpeg в систему или добавьте в PATH. yt-dlp вызывает ffmpeg для mux/конвертации.
- Медленная скорость/ограничения: повторите загрузку (повторы включены), используйте прокси, попробуйте позже.
- Проблемы с Unicode в PowerShell: убедитесь, что шрифт и кодировка консоли поддерживают UTF‑8; избегайте конвейеров, которые ломают кодировку.
- Ошибка по отдельному видео в плейлисте: утилита продолжит остальные; общий код возврата может быть 2.
- Повторная загрузка существующего файла: используйте `--interactive` для проверки и выбора перезаписи, или удалите старый файл вручную.

---

## 11. Правовые замечания

Используйте инструмент в соответствии с законодательством и условиями обслуживания площадок (YouTube, VK и других сервисов). Скачивайте только те материалы, на которые у вас есть права.

