# Дорожная карта разработки — ytd

> Подробный план развития и карта функций для загрузчика YouTube ytd
>
> Текущая версия: MVP 1.0 (27 октября 2025)
> Дата обновления: 27 октября 2025

---

## Содержание

1. [Анализ текущего состояния](#анализ-текущего-состояния)
2. [Обзор архитектуры](#обзор-архитектуры)
3. [Ветки развития](#ветки-развития)
4. [Матрица приоритетов](#матрица-приоритетов)
5. [Подробный роадмап функций](#подробный-роадмап-функций)
6. [Технический долг и рефакторинг](#технический-долг-и-рефакторинг)
7. [Долгосрочное видение](#долгосрочное-видение)

---

## Анализ текущего состояния

### ✅ Реализовано (MVP 1.0)

**Базовые возможности:**
- Загрузка одиночных видео/аудио с пресетами качества
- Пакетная загрузка плейлистов (последовательная обработка)
- Интерактивный режим для одиночных видео с выбором качества
- Интерактивный режим для плейлистов с едиными настройками
- Кастомизация имён файлов (префикс, суффикс, полная замена)
- Обнаружение дубликатов по ID видео с настройкой перезаписи
- Умные стратегии подбора качества (режимы «эконом» и «богато»)
- Индикаторы прогресса с цветным выводом в терминал
- Конфигурация через YAML и переменные окружения
- Сохранение метаданных в формате JSONL
- Пакетная обработка URL из файлов
- Полная русскоязычная документация

**Техническая реализация:**
- Python 3.11+ с type hints и dataclasses
- Бэкенд на yt-dlp для извлечения видео
- CLI на Typer с форматированием rich
- Набор тестов на pytest (29 тестов проходят)
- Модульная архитектура с чётким разделением ответственности
- Повторы с экспоненциальной задержкой
- Кроссплатформенность (Windows, Linux, macOS)

### 🔍 Ограничения сейчас

1. **Интерактивный режим:**
   - Режим «на каждый элемент плейлиста» пока не реализован (помечен TODO)
   - Нет предпросмотра первых N имён файлов перед стартом массовой загрузки
   - Нет опции «применить к оставшимся» в покадровом режиме

2. **Производительность:**
   - Только последовательная обработка плейлистов (без параллелизма)
   - Нет возобновления прерванных загрузок
   - Нет ограничения пропускной способности (bandwidth)

3. **Контентные возможности:**
   - Нет поддержки загрузки субтитров
   - Нет выгрузки миниатюр (thumbnails)
   - Нет извлечения глав/сегментов
   - Нет архивации описаний/комментариев

4. **UX/UI:**
   - Нет управления очередью загрузок
   - Нет прогресс-баров в реальном времени (только хуки)
   - Нет web UI или GUI
   - Нет системы уведомлений

5. **Продвинутые фичи:**
   - Нет режима полного архива канала/пользователя
   - Нет планировщика загрузок
   - Нет автоматизации пост-обработки (кастомные ffmpeg фильтры)
   - Нет контент-фильтров (длительность, просмотры и т.д.)
   - Нет интеграции с медиабиблиотеками (Plex, Jellyfin)

---

## Обзор архитектуры

### Текущая архитектура

```
┌─────────────────────────────────────────────────────────────┐
│                           CLI-слой                           │
│                    (ytd/cli.py — Typer)                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   download   │  │     info     │  │  interactive │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                      Слой бизнес-логики                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Downloader  │  │ Interactive  │  │    Config    │      │
│  │   (обёртка)  │  │  (помощники) │  │  (загрузчик) │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                   Инфраструктурный слой                      │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   yt-dlp     │  │  Файловая    │  │  Логирование │      │
│  │    (API)     │  │  система     │  │   (setup)    │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

### Предлагаемые расширения

```
Новые слои:
┌─────────────────────────────────────────────────────────────┐
│                Слой представления (в перспективе)            │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │    Web UI    │  │   REST API   │  │   TUI/GUI    │      │
│  │   (FastAPI)  │  │   (FastAPI)  │  │  (Textual)   │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│            Очереди и воркеры (в перспективе)                 │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │  Task Queue  │  │ Worker Pool  │  │  Scheduler   │      │
│  │   (asyncio)  │  │ (concurrent) │  │ (APScheduler)│      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                 Слой хранения (в перспективе)                │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐      │
│  │   Database   │  │    Cache     │  │   Reports    │      │
│  │   (SQLite)   │  │   (Redis?)   │  │ (CSV/Excel)  │      │
│  └──────────────┘  └──────────────┘  └──────────────┘      │
└─────────────────────────────────────────────────────────────┘
```

---

## Ветки развития

### 🌿 Стратегия веток

**Основные направления разработки:**

1. **Core Functionality** — расширение возможностей загрузки
2. **UX/UI Enhancements** — улучшение пользовательского опыта
3. **Performance & Scale** — оптимизация и параллелизм
4. **Content Features** — метаданные, субтитры, главы
5. **Integration & Distribution** — упаковка, API, интеграции
6. **Quality & Maintenance** — тесты, рефакторинг, документация

---

## Матрица приоритетов

```
Матрица «Эффект × Затраты»:

High Impact │ 2. Пер-видео режим     │ 1. Параллельные загрузки │
           │ 3. Возобновление       │ 5. Web UI               │
           │ 4. Субтитры/превью     │ 8. Архив канала         │
           │────────────────────────┼─────────────────────────│
           │ 7. Прогресс в TUI      │ 9. REST API             │
Low Impact │ 10. Уведомления        │ 11. Синхр. медиатеки    │
           └────────────────────────┴─────────────────────────┘
             Низкие затраты             Высокие затраты

Порядок приоритета (по кварталам):
Q1 2026: 2, 3, 4, 7
Q2 2026: 1, 6, 12
Q3 2026: 5, 8, 13
Q4 2026: 9, 14, 15
```

---

## Подробный роадмап функций

### Фаза 1: Завершение интерактивного режима (Q1 2026)

#### 1.1 Покадровый интерактивный режим для плейлистов
**Статус:** TODO (помечено в коде)
**Приоритет:** Высокий
**Затраты:** Средние
**Эффект:** Высокий

**Описание:**
Доработать интерактивный режим плейлистов: выбор качества для каждого видео с опцией «применить к оставшимся».

**Детали реализации:**
- Показ информации о видео (название, длительность, миниатюра) для каждого элемента
- Персональный выбор качества
- Чекбокс «Применить ко всем оставшимся»
- Опция «Пропустить это видео»
- Прогресс: «Видео 5 из 23»
- Массовые действия: «Пропустить оставшиеся», «Использовать те же настройки для оставшихся»

**Файлы для изменений:**
- `ytd/interactive.py` — диалоги покадрового режима
- `ytd/cli.py` — поток управления покадровым режимом (строка 290)

**Критерии приёмки:**
- Пользователь выбирает качество для каждого видео
- Можно применить настройки ко всем оставшимся
- Можно пропускать отдельные видео
- Счётчик прогресса показывает позицию
- Dry-run отображает все решения перед стартом

**Покрытие тестами:**
- Unit-тесты для новых функций интерактива
- Интеграционный тест с мок-плейлистом (3–5 элементов)
- Ручной тест на реальном плейлисте

---

#### 1.2 Предпросмотр имён файлов
**Статус:** Новое
**Приоритет:** Средний
**Затраты:** Низкие
**Эффект:** Средний

**Описание:**
Показывать предпросмотр первых 3–5 имён файлов перед запуском, чтобы подтвердить схему именования.

**Детали реализации:**
- Генерировать примеры на основе реальных метаданных
- Показ нормализованных имён с префиксами/суффиксами
- Подсветка возможных конфликтов (дубликаты имён)
- Подтверждение: «Продолжить загрузку? [Y/n]»
- Возможность вернуться и скорректировать настройки

**Файлы для изменений:**
- `ytd/interactive.py` — функция предпросмотра
- `ytd/cli.py` — вызов предпросмотра перед циклом загрузки

**Критерии приёмки:**
- Предпросмотр показывает 3–5 реальных имён
- Видна нормализация и нумерация
- Можно отменить и изменить настройки
- Появляются предупреждения о дубликатах

---

#### 1.3 Улучшенное обнаружение дубликатов
**Статус:** Улучшение
**Приоритет:** Средний
**Затраты:** Низкие
**Эффект:** Средний

**Описание:**
Расширить определение дубликатов: нечеткое сравнение и частичные файлы.

**Текущее состояние:**
- Точное вхождение `[VIDEO_ID]`
- Простая подсказка перезаписи

**Улучшения:**
- Обнаружение частичных загрузок (незавершённых файлов)
- Нечеткое совпадение по названию (порог 90%+)
- Показ размера и даты существующего файла
- Опции: перезаписать, пропустить, переименовать, возобновить (если частичный)
- Массовые режимы: «Всегда перезаписывать», «Всегда пропускать», «Всегда переименовывать»

**Файлы для изменений:**
- `ytd/utils.py` — улучшить `find_existing_files()`
- `ytd/interactive.py` — улучшить диалоги перезаписи

**Критерии приёмки:**
- Частичные файлы определяются
- Пользователь видит детали существующего файла
- Несколько стратегий разрешения конфликта
- Массовые настройки уменьшают число диалогов

---

### Фаза 2: Производительность и масштабирование (Q2 2026)

#### 2.1 Параллельные загрузки
**Статус:** Новое
**Приоритет:** Высокий
**Затраты:** Высокие
**Эффект:** Высокий

**Описание:**
Реализовать конкурентные загрузки с настраиваемым пулом воркеров для плейлистов и списков URL.

**Технический подход:**
- Использовать `concurrent.futures.ThreadPoolExecutor` для I/O-операций yt-dlp
- Настраиваемое число воркеров (по умолчанию 3, максимум 10)
- Трекинг прогресса активных загрузок
- Изоляция ошибок (сбой одной не влияет на другие)
- Ограничение частоты стартов для избежания банов

**Детали реализации:**
```python
# Новый модуль: ytd/parallel.py
class ParallelDownloader:
    def __init__(self, max_workers: int = 3, rate_limit: float = 1.0):
        self.executor = ThreadPoolExecutor(max_workers=max_workers)
        self.rate_limiter = RateLimiter(rate_limit)
    
    def download_batch(self, urls: list[str], options: DownloadOptions):
        futures = []
        for url in urls:
            future = self.executor.submit(self._download_with_rate_limit, url, options)
            futures.append(future)
        
        # Ждём и собираем результаты
        results = []
        for future in as_completed(futures):
            results.append(future.result())
        return results
```

**Конфигурация:**
```yaml
# ytd.yaml
parallel:
  enabled: true
  max_workers: 3
  rate_limit: 1.0  # секунды между стартами
```

**Новые файлы:**
- `ytd/parallel.py` — реализация параллельных загрузок
- `ytd/rate_limiter.py` — утилита ограничения частоты

**Изменения:**
- `ytd/cli.py` — флаг `--parallel` и опция количества воркеров
- `ytd/config.py` — настройки параллельности
- `ytd/types.py` — расширение датакласса конфигурации

**Критерии приёмки:**
- Несколько видео загружаются одновременно
- Прогресс отслеживается по каждому файлу
- Сбой одной загрузки не останавливает остальные
- Ограничение частоты предотвращает баны
- Умеренное потребление ресурсов
- Тест на плейлисте 10+ видео

---

#### 2.2 Возобновление прерванных загрузок
**Статус:** Новое
**Приоритет:** Высокий
**Затраты:** Средние
**Эффект:** Высокий

**Описание:**
Поддержка возобновления загрузок с использованием встроенных возможностей yt-dlp.

**Детали реализации:**
- Хранить состояние загрузки в каталоге `.ytd_state/`
- Отслеживать частичные файлы с расширением `.part`
- Обнаружить и возобновлять частичные загрузки
- Очищать состояние после успешной загрузки
- Аккуратно обрабатывать сбои возобновления

**Формат state-файла (JSON):**
```json
{
  "video_id": "abc123",
  "url": "https://...",
  "partial_file": "path/to/video.part",
  "bytes_downloaded": 12345678,
  "total_bytes": 98765432,
  "format": "bestvideo+bestaudio",
  "started_at": "2026-01-15T10:30:00Z",
  "last_updated": "2026-01-15T10:35:00Z"
}
```

**Новые файлы:**
- `ytd/resume.py` — управление состоянием возобновления

**Изменения:**
- `ytd/downloader.py` — интеграция возобновления
- `ytd/utils.py` — утилиты работы с состоянием

**Критерии приёмки:**
- Прерванные загрузки продолжаются с места остановки
- Состояние удаляется по завершении
- Работает с параллельными загрузками
- Команда ручного возобновления: `ytd resume`

---

#### 2.3 Ограничение скорости (Bandwidth Limiting)
**Статус:** Новое
**Приоритет:** Низкий
**Затраты:** Низкие
**Эффект:** Средний

**Описание:**
Ограничение пропускной способности, чтобы не забивать сеть.

**Детали реализации:**
- Использовать опцию yt-dlp `ratelimit`
- Флаг CLI: `--rate-limit 1M` (1 МБ/с)
- Настройка в конфиге: `rate_limit: "1M"`
- Поддерживаемые единицы: K, M, G (байт/сек)

**Изменения:**
- `ytd/downloader.py` — добавить ratelimit в ydl_opts
- `ytd/cli.py` — флаг CLI
- `ytd/types.py` — поле rate_limit

**Критерии приёмки:**
- Скорость загрузки соблюдает лимит
- Работает с параллельными загрузками
- Корректный парсинг единиц

---

### Фаза 3: Контентные фичи (Q2 2026)

#### 3.1 Субтитры
**Статус:** Частично (поле в конфиге есть, в UX не выведено)
**Приоритет:** Высокий
**Затраты:** Низкие
**Эффект:** Высокий

**Описание:**
Полная поддержка субтитров, форматов и авто-перевода.

**Текущее состояние:**
- Поле `subtitles` в конфиге есть
- В интерактиве нет
- Не покрыто тестами

**Улучшения:**
- CLI: `--subtitles en,ru --subtitle-format srt`
- Интерактив: чекбокс «Скачать субтитры»
- Автоперевод: `--subtitle-translate ru` (на русский)
- Встраивание в видео: `--embed-subs`
- Отдельные файлы: .srt/.vtt рядом

**Изменения:**
- `ytd/downloader.py` — корректная конфигурация опций субтитров
- `ytd/interactive.py` — диалог по субтитрам
- `ytd/cli.py` — флаги CLI

**Критерии приёмки:**
- Субтитры скачиваются на указанных языках
- Автоперевод работает
- Встраивание работает для MP4
- Отдельные файлы создаются корректно

---

#### 3.2 Миниатюры (thumbnails)
**Статус:** Новое
**Приоритет:** Средний
**Затраты:** Низкие
**Эффект:** Средний

**Описание:**
Загрузка и, опционально, встраивание миниатюр.

**Реализация:**
- CLI: `--thumbnail --embed-thumbnail`
- Интерактив: чекбокс
- Сохранение JPG/PNG
- Встраивание в метаданные MP4/M4A
- Выбор разрешения

**Опции yt-dlp:**
```python
'writethumbnail': True,
'embedthumbnail': True,  # для m4a требуется AtomicParsley
```

**Изменения:**
- `ytd/downloader.py` — опции миниатюр
- `ytd/interactive.py` — чекбокс миниатюр
- `ytd/types.py` — поля для миниатюр

**Критерии приёмки:**
- Миниатюра сохраняется отдельно
- Миниатюра встраивается в метаданные
- Работает для аудио-only

---

#### 3.3 Главы/сегменты
**Статус:** Новое
**Приоритет:** Низкий
**Затраты:** Средние
**Эффект:** Низкий

**Описание:**
Извлечение и сохранение глав/сегментов как отдельных файлов или метаданных.

**Возможности:**
- Сохранение списка глав в JSON
- Разбиение видео по главам (опционально)
- Сохранение метаданных глав в файле

**Use Cases:**
- Подкасты с сегментами
- Образовательные видео с разделами
- Музыкальные альбомы с трек-листом

**Новые файлы:**
- `ytd/chapters.py` — утилиты глав

**Критерии приёмки:**
- Метаданные глав сохраняются
- Есть опциональное разбиение по главам
- Информация о главах видна в прогрессе

---

#### 3.4 Архивация описаний и комментариев
**Статус:** Новое
**Приоритет:** Низкий
**Затраты:** Средние
**Эффект:** Низкий

**Описание:**
Архивация описаний, комментариев и прочих метаданных для исследований/архивов.

**Возможности:**
- Флаг `--archive-metadata`
- Сохранение в JSON или SQLite
- Включая: описание, топ-N комментариев, теги, таймкоды
- Опционально: полные ветки комментариев

**Новые файлы:**
- `ytd/archiver.py` — архивация метаданных

**Критерии приёмки:**
- Полное описание сохранено
- Сохранены топ-N комментариев
- Данные структурированы и доступны для поиска

---

### Фаза 4: Улучшения UX/UI (Q1 2026)

#### 4.1 Богатые прогресс-бары
**Статус:** Улучшение
**Приоритет:** Высокий
**Затраты:** Низкие
**Эффект:** Высокий

**Описание:**
Заменить текущие хуки прогресса на `rich.progress` с реальными прогресс-барами.

**Текущее состояние:**
- Базовые хуки прогресса (только DEBUG)
- Минимальная визуальная обратная связь

**Улучшения:**
- Реальные прогресс-бары с %/скоростью/ETA
- Несколько параллельных баров при параллельных загрузках
- Цветовые статусы (downloading, processing, finished, error)
- Общий прогресс плейлиста + прогресс отдельных файлов

**Реализация:**
```python
from rich.progress import Progress, SpinnerColumn, BarColumn, TextColumn

with Progress(
    SpinnerColumn(),
    TextColumn("[progress.description]{task.description}"),
    BarColumn(),
    TextColumn("[progress.percentage]{task.percentage:>3.0f}%"),
    TextColumn("•"),
    TextColumn("[cyan]{task.completed}/{task.total}"),
) as progress:
    task = progress.add_task("Downloading video...", total=100)
    # Обновление прогресса в хуке
```

**Изменения:**
- `ytd/downloader.py` — интеграция rich.progress
- `ytd/cli.py` — управление отображением

**Критерии приёмки:**
- Плавные прогресс-бары видны
- Несколько загрузок — несколько баров
- Показ скорости и ETA
- Работает и в verbose, и в quiet режимах

---

#### 4.2 TUI (Text User Interface)
**Статус:** Новое
**Приоритет:** Средний
**Затраты:** Высокие
**Эффект:** Средний

**Описание:**
Полноценный TUI на `textual` для интерактивного поиска и загрузки.

**Функции:**
- Поиск YouTube прямо из TUI
- Просмотр результатов с «миниатюрами» (ASCII)
- Управление очередью (добавить, удалить, упорядочить)
- Онлайн-мониторинг прогресса
- История загрузок
- Панель настроек

**Технологии:**
- `textual` — современный TUI-фреймворк
- `rich` для отрисовки
- Асинхронная архитектура

**Экраны:**
```
┌────────────────────────────────────────────────┐
│ ytd — YouTube Downloader TUI           [v1.0] │
├────────────────────────────────────────────────┤
│  Search: [____________________________]  [Go]  │
├────────────────────────────────────────────────┤
│  Queue (3 items):                              │
│  1. Video Title #1          [1080p] [▶ Ready] │
│  2. Video Title #2           [720p] [⏸ Paused]│
│  3. Playlist (45 videos)    [best]  [⏳ Active]│
├────────────────────────────────────────────────┤
│  Active Downloads:                             │
│  ┌─ Video Title #3 ───────────────┐            │
│  │ [████████░░░░░░░░░░] 45% 2.1MB/s│            │
│  └────────────────────────────────┘            │
├────────────────────────────────────────────────┤
│  [Add URL] [Settings] [History] [Quit]        │
└────────────────────────────────────────────────┘
```

**Новые файлы:**
- `ytd/tui/` — подпакет
- `ytd/tui/app.py` — главное приложение
- `ytd/tui/screens/` — экраны
- `ytd/tui/widgets/` — виджеты

**Новая команда:**
```bash
ytd tui  # Запуск TUI
```

**Критерии приёмки:**
- TUI запускается без ошибок
- Базовая навигация работает (клавиатура/мышь)
- Очередь управляется
- Загрузки стартуют из TUI
- Прогресс виден в реальном времени

---

#### 4.3 Уведомления на рабочий стол
**Статус:** Новое
**Приоритет:** Низкий
**Затраты:** Низкие
**Эффект:** Низкий

**Описание:**
Системные уведомления при завершении/ошибках загрузки.

**Реализация:**
- `plyer` для кроссплатформенности
- Настройка: флаг `--notify` или `notify: true` в конфиге
- События: завершение загрузки, ошибка, завершение плейлиста

**Новые файлы:**
- `ytd/notifications.py`

**Критерии приёмки:**
- Уведомления отображаются
- Кроссплатформенно (Windows, Linux, macOS)
- Можно отключить

---

### Фаза 5: Продвинутые возможности (Q3 2026)

#### 5.1 Архив канала/пользователя
**Статус:** Новое
**Приоритет:** Средний
**Затраты:** Высокие
**Эффект:** Средний

**Описание:**
Загрузка всех видео канала с инкрементальными обновлениями.

**Функции:**
- `ytd archive @username` — первичный архив канала
- `ytd update @username` — скачивать только новые видео
- Хранение состояния в базе (SQLite)
- Фильтры по дате, просмотрам, длительности
- Возобновление прерванных архивов
- Планировщик обновлений (cron/systemd timer)

**Схема БД:**
```sql
CREATE TABLE channels (
    channel_id TEXT PRIMARY KEY,
    channel_name TEXT,
    last_checked TIMESTAMP,
    video_count INTEGER
);

CREATE TABLE archived_videos (
    video_id TEXT PRIMARY KEY,
    channel_id TEXT,
    title TEXT,
    uploaded_at TIMESTAMP,
    downloaded_at TIMESTAMP,
    file_path TEXT,
    FOREIGN KEY (channel_id) REFERENCES channels(channel_id)
);
```

**Команды:**
```bash
ytd archive @channelname           # Первичный архив
ytd update @channelname            # Инкрементальное обновление
ytd archive status @channelname    # Информация об архиве
ytd archive list                   # Список архивов
```

**Новые файлы:**
- `ytd/archive/` — подпакет
- `ytd/archive/db.py` — база SQLite
- `ytd/archive/manager.py` — менеджер архива

**Критерии приёмки:**
- Полная загрузка канала работает
- Инкрементальные обновления качают только новое
- Состояние сохраняется между запусками
- Фильтрация работает

---

#### 5.2 Планировщик загрузок
**Статус:** Новое
**Приоритет:** Низкий
**Затраты:** Средние
**Эффект:** Низкий

**Описание:**
Запуск загрузок по расписанию (ночью и т.п.).

**Реализация:**
- `APScheduler` для планирования
- CLI: `ytd schedule URL --at "02:00"` или `--in "2h"`
- Демо-режим: `ytd daemon start`
- Список задач: `ytd schedule list`
- Отмена: `ytd schedule cancel <id>`

**Новые файлы:**
- `ytd/scheduler.py`
- `ytd/daemon.py`

**Критерии приёмки:**
- Загрузки стартуют в нужное время
- Демон работает в фоне
- Задачи сохраняются между рестартами

---

#### 5.3 Автоматизация пост-обработки
**Статус:** Новое
**Приоритет:** Низкий
**Затраты:** Высокие
**Эффект:** Низкий

**Описание:**
Кастомные ffmpeg-фильтры и пайплайны пост-обработки.

**Возможности:**
- Кастомные ffmpeg-аргументы: `--ffmpeg-args "-vf scale=1280:-1"`
- Обрезка: `--trim 00:30-05:00`
- Извлечение отрезка аудио
- Удаление водяных знаков (где легально)
- Автоконвертация в нужные форматы
- Скрипты/хуки пост-обработки

**Пример конфига:**
```yaml
post_processing:
  - name: "Convert to H.265"
    enabled: false
    ffmpeg_args: "-c:v libx265 -crf 28"
  - name: "Normalize Audio"
    enabled: true
    ffmpeg_args: "-af loudnorm"
```

**Новые файлы:**
- `ytd/postprocess.py`

**Критерии приёмки:**
- Фильтры применяются
- Поддерживается цепочка нескольких шагов
- Условная обработка по свойствам файла

---

### Фаза 6: Интеграции и дистрибуция (Q3–Q4 2026)

#### 6.1 Web UI
**Статус:** Новое
**Приоритет:** Средний
**Затраты:** Высокие
**Эффект:** Высокий

**Описание:**
Веб-интерфейс для удалённого управления и загрузок.

**Стек:**
- Backend: FastAPI
- Frontend: Vue.js 3 или React
- Real-time: WebSockets для прогресса
- Аутентификация: опционально (basic auth или OAuth)

**Функции:**
- Ввод URL/вставка ссылки
- Визуальный выбор качества
- Управление очередью
- Мониторинг прогресса
- История загрузок
- Панель настроек
- Адаптивность под мобильные

**Архитектура:**
```
┌──────────────┐      WebSocket       ┌──────────────┐
│   Browser    │ ◄──────────────────► │   FastAPI    │
│  (Vue.js)    │      HTTP/REST       │   Backend    │
└──────────────┘                      └──────────────┘
                                             │
                                             ▼
                                      ┌──────────────┐
                                      │  ytd Core    │
                                      │  (library)   │
                                      └──────────────┘
```

**Новые файлы:**
- `ytd_web/` — новый пакет
- `ytd_web/api.py` — роуты FastAPI
- `ytd_web/static/` — фронтенд-ассеты
- `ytd_web/websockets.py` — real-time обновления

**Новая команда:**
```bash
ytd serve --host 0.0.0.0 --port 8000
```

**Критерии приёмки:**
- Web UI доступен в браузере
- Загрузки стартуют из веб-интерфейса
- Прогресс обновляется в реальном времени
- Дизайн дружелюбен к мобильным

---

#### 6.2 REST API
**Статус:** Новое
**Приоритет:** Средний
**Затраты:** Средние
**Эффект:** Средний

**Описание:**
REST API для интеграций и автоматизации.

**Эндпоинты:**
```
POST   /api/downloads           # Start download
GET    /api/downloads           # List downloads
GET    /api/downloads/{id}      # Get download status
DELETE /api/downloads/{id}      # Cancel download
POST   /api/info                # Get video info
GET    /api/config              # Get current config
PUT    /api/config              # Update config
GET    /api/health              # Health check
```

**Пример запроса:**
```bash
curl -X POST http://localhost:8000/api/downloads \
  -H "Content-Type: application/json" \
  -d '{
    "url": "https://youtube.com/watch?v=...",
    "quality": "1080p",
    "output": "/downloads"
  }'
```

**Пример ответа:**
```json
{
  "download_id": "uuid-here",
  "status": "queued",
  "url": "https://youtube.com/watch?v=...",
  "title": "Video Title",
  "estimated_size": "125MB"
}
```

**Новые файлы:**
- `ytd/api/` — подпакет
- `ytd/api/routes.py` — эндпоинты
- `ytd/api/models.py` — Pydantic-модели

**Критерии приёмки:**
- Эндпоинты отвечают корректно
- Генерируется OpenAPI/Swagger
- Аутентификация опциональна, но поддерживается
- Реализован rate limiting

---

#### 6.3 Docker-образ
**Статус:** Новое
**Приоритет:** Средний
**Затраты:** Низкие
**Эффект:** Средний

**Описание:**
Официальный Docker-образ для простого развёртывания.

**Dockerfile:**
```dockerfile
FROM python:3.11-slim

RUN apt-get update && apt-get install -y ffmpeg && rm -rf /var/lib/apt/lists/*

WORKDIR /app
COPY . .
RUN pip install --no-cache-dir -e .

VOLUME ["/downloads", "/config"]
EXPOSE 8000

ENTRYPOINT ["ytd"]
CMD ["serve", "--host", "0.0.0.0"]
```

**Docker Compose:**
```yaml
version: '3.8'
services:
  ytd:
    image: kogriv/ytd:latest
    ports:
      - "8000:8000"
    volumes:
      - ./downloads:/downloads
      - ./config:/config
    environment:
      - YTD_OUTPUT=/downloads
```

**Новые файлы:**
- `Dockerfile`
- `docker-compose.yml`
- `.dockerignore`

**Критерии приёмки:**
- Образ собирается
- Контейнер запускает ytd
- Томá сохраняют загрузки
- Поддержка архитектур amd64/arm64

---

#### 6.4 Готовые бинарники
**Статус:** Новое
**Приоритет:** Низкий
**Затраты:** Средние
**Эффект:** Средний

**Описание:**
Самодостаточные исполняемые файлы для Windows, Linux, macOS (PyInstaller).

**Сборка:**
```bash
pyinstaller --onefile --name ytd ytd/cli.py
```

**Дистрибуция:**
- GitHub Releases с бинарниками
- Автосборки GitHub Actions
- Подпись кода (Windows/macOS)

**Новые файлы:**
- `ytd.spec` — spec-файл PyInstaller
- `.github/workflows/build.yml` — CI/CD

**Критерии приёмки:**
- Работает без установленного Python
- Все платформы поддержаны
- Размер файла разумный (<50 МБ)

---

#### 6.5 Интеграция с медиасерверами
**Статус:** Новое
**Приоритет:** Низкий
**Затраты:** Высокие
**Эффект:** Низкий

**Описание:**
Интеграция с Plex, Jellyfin, Kodi для обновления медиатек.

**Функции:**
- Автоскан медиатеки после загрузки
- Сопоставление метаданных под формат медиасервера
- Организация по сериям/сезонам (для архивов шоу)
- Генерация .nfo для Kodi

**Новые файлы:**
- `ytd/integrations/` — плагины интеграций
- `ytd/integrations/plex.py`
- `ytd/integrations/jellyfin.py`

**Критерии приёмки:**
- Загрузки триггерят перескан
- Метаданные корректно оформлены
- Работает с популярными серверами

---

### Фаза 7: Качество и сопровождение (непрерывно)

#### 7.1 Расширение покрытия тестами
**Статус:** Постоянно
**Приоритет:** Высокий
**Затраты:** Средние
**Эффект:** Высокий

**Текущее покрытие:** ~60% (оценка)

**Цели:**
- 90%+ покрытие
- Интеграционные тесты для ключевых фич
- Бенчмарки производительности
- Регрессионный набор

**Типы тестов:**
- Unit (уже есть)
- Интеграционные (частично)
- E2E (smoke для CLI)
- Производительность (большие плейлисты)
- Безопасность (валидация ввода)

**Расширять в:**
- `tests/` — все модули тестов

---

#### 7.2 Бенчмаркинг производительности
**Статус:** Новое
**Приоритет:** Средний
**Затраты:** Средние
**Эффект:** Средний

**Метрики:**
- Скорость загрузки vs базовый yt-dlp
- Память при параллельных загрузках
- Время старта
- Время обработки плейлистов

**Инструменты:**
- `pytest-benchmark` для бенчей
- `memory_profiler` для памяти
- GitHub Actions для CI-бенчмарков

**Новые файлы:**
- `tests/benchmarks/` — набор бенчмарков
- `.github/workflows/benchmark.yml`

---

#### 7.3 Аудит безопасности
**Статус:** Новое
**Приоритет:** Средний
**Затраты:** Низкие
**Эффект:** Высокий

**Зоны проверки:**
- Валидация ввода (URL, пути)
- Риски shell-инъекций (ffmpeg args)
- Path traversal
- Уязвимости зависимостей (Dependabot)

**Инструменты:**
- `bandit` — линтинг безопасности Python
- `safety` — проверка зависимостей
- Ручной код-ревью

**Критерии приёмки:**
- Нет критичных уязвимостей
- Полная валидация ввода
- Актуальные зависимости

---

#### 7.4 Расширение документации
**Статус:** Постоянно
**Приоритет:** Высокий
**Затраты:** Низкие
**Эффект:** Высокий

**Добавить документы:**
- API-документация (Sphinx или MkDocs)
- Руководство для контрибьюторов
- Кодекс поведения
- Troubleshooting
- FAQ
- Видеоруководства (опционально)

**Новые файлы:**
- `docs/api/` — справочник API
- `docs/contributing.md`
- `docs/troubleshooting.md`
- `docs/faq.md`

---

#### 7.5 Интернационализация (i18n)
**Статус:** Новое
**Приоритет:** Низкий
**Затраты:** Средние
**Эффект:** Средний

**Описание:**
Поддержка языков помимо русского/английского.

**Реализация:**
- `gettext` для переводов
- Экспорт строк в `.po`
- Выбор языка: `--lang en`

**Целевые языки:**
- Английский (en)
- Русский (ru) — текущий
- Испанский (es)
- Немецкий (de)
- Французский (fr)

**Новые файлы:**
- `ytd/locale/` — файлы переводов

---

## Технический долг и рефакторинг

### Текущий технический долг

1. TODO в `cli.py` (строка 290): покадровый режим плейлистов не реализован
2. TODO в `utils.py` (строка 122): обёртка повторов по сети пока не требуется
3. Ограниченная обработка ошибок: часть крайних кейсов не покрыта
4. Нет async/await: все операции синхронны
5. Управление состоянием: нет персистентного состояния между запусками
6. Валидация конфигурации: ограниченная

### Возможности рефакторинга

#### R1: «Тонкий» CLI-контроллер
**Проблема:** в `cli.py` смешаны бизнес-логика и представление
**Решение:** вынести логику в сервисный слой; CLI только I/O

**До:**
```python
# cli.py
def cmd_download(...):
    # 200 строк логики
```

**После:**
```python
# cli.py
def cmd_download(...):
    service = DownloadService(config, logger)
    service.download(options)

# ytd/services/download_service.py
class DownloadService:
    def download(self, options): ...
```

---

#### R2: Введение сервисного слоя
**Проблема:** жёсткая связь между CLI и Downloader
**Решение:** добавить сервисный слой для бизнес-логики

**Структура:**
```
ytd/
  cli.py          — Presentation (CLI)
  services/       — Business Logic (NEW)
    download_service.py
    info_service.py
    archive_service.py
  downloader.py   — Infrastructure (yt-dlp wrapper)
```

---

#### R3: Переход на async/await
**Проблема:** синхронные операции блокируются
**Решение:** рефакторинг на async для лучшей конкуренции

**Преимущества:**
- Лучшая утилизация ресурсов
- Чище реализация параллельных загрузок
- Подготовка к web UI

**Область:**
- `downloader.py` — async-методы
- `cli.py` — async-обработчики команд
- Зависимости: `asyncio`, `aiofiles`

---

#### R4: Плагинная архитектура
**Проблема:** сложно расширять без правок ядра
**Решение:** ввести систему плагинов

**Сценарии:**
- Кастомные пост-процессоры
- Дополнительные источники (Vimeo и др.)
- Кастомные экстракторы метаданных

**Дизайн:**
```python
# ytd/plugins/base.py
class Plugin(ABC):
    @abstractmethod
    def process(self, video: Video) -> Video: ...

# Пользовательский плагин
class MyPlugin(Plugin):
    def process(self, video):
        # Custom logic
        return video

# Загрузка плагинов из конфигурации
plugins:
  - type: custom
    module: my_plugin.MyPlugin
    config: {...}
```

---

## Долгосрочное видение

### 2026: Завершённый по функциям CLI
- Реализованы все базовые фичи
- Стабильный API для библиотечного использования
- Полная документация
- Высокое покрытие тестами

### 2027: Платформа и экосистема
- Web UI готов к продакшену
- Стабильный REST API
- Маркетплейс плагинов
- Вклад сообщества
- Поддержка нескольких платформ (Vimeo, Dailymotion и др.)

### 2028+: ИИ и «умные» функции
- Умный выбор качества по скорости сети
- Автоматическая категоризация контента
- Поиск дубликатов между платформами
- Генерация транскриптов с помощью ИИ
- Рекомендации контента

---

## Как предлагать/менять пункты дорожной карты

**Смена приоритета:** пункты могут двигаться вверх/вниз в зависимости от:
- Отзывов пользователей и запросов фич
- Технических зависимостей
- Доступного времени контрибьюторов
- Важности уязвимостей/багов

**Предложить фичу:**
- Создайте GitHub issue с меткой `feature-request`
- Опишите сценарий использования и оценку эффекта
- Голосование сообщества через 👍

**Взять задачу:**
- Оставьте комментарий «Готов взяться»
- Обсудите подход к реализации
- Отправьте PR по гайдам для контрибьюторов

---

## Заключение

Эта дорожная карта даёт целостное представление о направлении развития ytd. У проекта прочная база MVP и понятные траектории расширения по нескольким направлениям:

- **Опыт пользователя:** TUI, Web UI, улучшенный прогресс
- **Производительность:** параллель, возобновление, кэширование
- **Контент:** субтитры, главы, полноценный архив
- **Интеграции:** API, Docker, синхронизация медиатек
- **Качество:** тесты, бенчмарки, безопасность

Модульная архитектура позволяет вести параллельную разработку веток, принимая вклад сообщества и сохраняя стабильность.

**Ближайшие шаги:**
1. Завершить покадровый интерактивный режим (Фаза 1.1)
2. Внедрить rich-прогресс бары (Фаза 4.1)
3. Добавить поддержку субтитров (Фаза 3.1)
4. Прототип параллельных загрузок (Фаза 2.1)

*Дата обновления: 27 октября 2025*
